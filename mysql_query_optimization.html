<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Mysql Query Optimization</title>
    <meta name="description" content="Mysql Query Optimization">
    <meta name="author" content="Stuart Ingram">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="reveal/css/reveal.min.css">
    <link rel="stylesheet" href="reveal/css/theme/default.css" id="theme">
    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="reveal/lib/css/zenburn.css">
    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="reveal/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>
    <!--[if lt IE 9]>
	<script src="reveal/lib/js/html5shiv.js"></script>
	<![endif]-->
  </head>

  <body>
    <div class="reveal">
      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

	<section>
	  <h1>Mysql</h1>
	  <h3>Query Optimization</h3>
	  <h4>Mysql 5.1+ & InnoDB</h4>
	  <p>
	    <small>Created by S Ingram / <a href="http://twitter.com/arethoseclams">@arethoseclams</a></small>
	  </p>
	  <p>
	    <small><a href="http://github.com/singram">http://github.com/singram</a></small>
	  </p>
	</section>
        <section>
          <h2>What this talk is</h2>
          <ul>
            <li>+ Optimizing a single query</li>
            <li>- Optimizing a database load generated by a system</li>
            <li>- Detection of bad queries</li>
          </ul>
        </section>

        <section>
          <h2>Sorry</h2>
          <p><b>There is no silver bullet</b></p>
        </section>

        <section>
          <h2>#1 Rule</h2>
        </section>
        <section>
          <h2>Don't Guess!!</h2>
          <ul>
            <li>You can't improve something if you don't know how it
              behaved previously</li>
            <li>Measure</li>
          </ul>
        </section>
        <section>
          <h2>#2 Rule</h2>
        </section>
        <section>
          <h2>Understand the data</h2>
          <ul>
            <li>If you don't understand the data you are operating on
              you can't effectively optimize your query.</li>
            <li>Usage</li>
	    <li>Characteristics</li>
          </ul>
        </section>

        <section>
          <h2>Beware</h2>
          <ul>
            <li>Timing is important but not the only metric</li>
            <li class="fragment">Query cache</li>
            <ul class="fragment">
              <li>Turn off <br>
                <small>(may actually be better for some workloads)</small></li>
              <li>SQL_NO_CACHE<br>
                <small>SELECT SQL_NO_CACHE foo FROM bar WHERE id = 1;</small></li>
            </ul>
          </ul>
        </section>

        <section>
          <h2>Typical investigation</h2>
          <ul>
            <li>Indexes</li>
            <li class="fragment">Query structure</li>
            <li class="fragment">Data types</li>
            <li class="fragment">Schema structure</li>
          </ul>
        </section>


        <section>
          <h2>Indexes make things faster</h2>
          <ul>
            <li>So lets index everything right?!</li>
            <li>AKA The index shotgun</li>
          </ul>
        </section>

        <section>
          <h2>Shotgun example (BOOM!)</h2>
	    <pre><code data-trim contenteditable>
CREATE TABLE `fakenames_shotgun` (
  `id`            BIGINT(20)   NOT NULL AUTO_INCREMENT,
  `Gender`        VARCHAR(100) NOT NULL,
  `GivenName`     VARCHAR(100) NOT NULL,
  `MiddleInitial` VARCHAR(100) NOT NULL,
  `Surname`       VARCHAR(100) NOT NULL,
  PRIMARY KEY (`id`),
  INDEX (`Gender`),
  INDEX (`GivenName`),
  INDEX (`MiddleInitial`),
  INDEX (`Surname`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>
        </section>

        <section>
          <h2>So why is this bad?</h2>
          <ul>
            <li>Redundancy (you don't need them)</li>
	    <li>Duplication (I'll get to this later)</li>
	    <li class="fragment">Write cost</li>
	    <li class="fragment">Storage cost</li>
	    <li class="fragment">Read cost <small>(QEP generation)</small></li>
            <li class="fragment">Indexes not intelligently applied<br>
              No covering or compound indexes</li>
          </ul>
        </section>

        <section>
          <h2>Index Types 101</h2>
          <ul>
            <li>Primary index</li>
            <li>Secondary indexes</li>
            <ul class="fragment">
              <li>Unique</li>
              <li>Index</li>
            </ul>
          </ul>
        </section>

        <section>
          <h2>B-Trees - CS 101 flashback</h2>
        </section>

        <section>
          <h2>Primary key selection</h2>
          <ul>
            <li>Indexes are clustered in a B-Tree</li>
            <li class="fragment">Primary indexes contain data</li>
            <li class="fragment">Sequential vs Random (GUID) vs None</li>
            <li class="fragment">Second indexes contain primary key value</li>
            <li class="fragment">PK Size is important for secondary keys</li>
            <li class="fragment">Cardinality of an index
              <br>High good (created_at)
              <br>Low bad (gender)
            </li>
          </ul>
        </section>

        <section>
          <section>
            <h2>Sample data</h2>
            <ul>
              <li><a href="http://www.wunderground.com/history/airport/PITT/2007/1/1/CustomHistory.html?dayend=31&monthend=12&yearend=2007&req_city=NA&req_state=NA&req_statename=NA">Weather
                  underground</a></li>
              <li><a href="http://www.fakenamegenerator.com/order.php">FakeNameGenerator.com</a><br><small>1M
              record dump available (schema below)</small></li>
            </ul>
          </section>
          <section>
	    <pre><code data-trim contenteditable>
DROP TABLE `fakenames_full`;
CREATE TABLE `fakenames_full` (
  `id`              BIGINT(20) NOT NULL AUTO_INCREMENT,
  `Gender`          VARCHAR(100) NOT NULL,
  `GivenName`       VARCHAR(100) NOT NULL,
  `MiddleInitial`   VARCHAR(100) NOT NULL,
  `Surname`         VARCHAR(100) NOT NULL,
  `StreetAddress`   VARCHAR(100) NOT NULL,
  `City`            VARCHAR(100) NOT NULL,
  `State`           VARCHAR(100) NOT NULL,
  `ZipCode`         VARCHAR(100) NOT NULL,
  `Country`         VARCHAR(100) NOT NULL,
  `EmailAddress`    VARCHAR(100) NOT NULL,
  `Username`        VARCHAR(100) NOT NULL,
  `Password`        VARCHAR(100) NOT NULL,
  `TelephoneNumber` VARCHAR(100) NOT NULL,
  `MothersMaiden`   VARCHAR(100) NOT NULL,
  `dob`             DATETIME DEFAULT 0,
  `CCType`          VARCHAR(100) NOT NULL,
  `CCNumber`        VARCHAR(100) NOT NULL,
  `CVV2`            VARCHAR(100) NOT NULL,
  `CCExpires`       VARCHAR(100) NOT NULL,
  `NationalID`      VARCHAR(100) NOT NULL DEFAULT '',
  `UPS`             VARCHAR(100) NOT NULL,
  `Occupation`      VARCHAR(100) NOT NULL,
  `Company`         VARCHAR(100) NOT NULL,
  `Vehicle`         VARCHAR(100) NOT NULL,
  `Domain`          VARCHAR(100) NOT NULL,
  `BloodType`       VARCHAR(100) NOT NULL,
  `Pounds`          VARCHAR(100) NOT NULL,
  `Kilograms`       VARCHAR(100) NOT NULL,
  `FeetInches`      VARCHAR(100) NOT NULL,
  `Centimeters`     VARCHAR(100) NOT NULL,
  `GUID`            VARCHAR(100) NOT NULL,
  `Latitude`        VARCHAR(100) NOT NULL,
  `Longitude`       VARCHAR(100) NOT NULL,
  `created_at`     TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

load data infile '/path_to/FakeNameGenerator.com.csv' into table fakenames_full fields terminated by ',' lines terminated by '\n';
Query OK, 1000000 rows affected, 65535 warnings (24.39 sec)
Records: 1000000  Deleted: 0  Skipped: 0  Warnings: 1000000
</code></pre>
<p>This fixes dates.  This is your friend</p>
<pre><code data-trim contenteditable>
sed  -i "s|,\([0-9]\+\)/\([0-9]\+\)/\([0-9]\+\),|,\3-\1-\2,|g" FileNameGenerator.com.csv
</code></pre>
          </section>
        </section>

        <section>
          <h2>1st Tool for query analysis</h2>
          <p>EXPLAIN</p>
	  <pre><code data-trim contenteditable>
EXPLAIN SELECT * FROM fakenames;
          </code></pre>
	  <pre><code data-trim contenteditable>
singram, presentation> explain select * from fakenames;
+----+-------------+-----------+------+---------------+------+---------+------+-------+-------+
| id | select_type | table     | type | possible_keys | key  | key_len | ref  | rows  | Extra |
+----+-------------+-----------+------+---------------+------+---------+------+-------+-------+
|  1 | SIMPLE      | fakenames | ALL  | NULL          | NULL | NULL    | NULL | 50071 |       |
+----+-------------+-----------+------+---------------+------+---------+------+-------+-------+
1 row in set (0.00 sec)
</code></pre>
          <p class="fragment"><small>(Works for UPDATE and DELETE statements in 5.6)</small></p>
        </section>

        <section>
          <h2>Understanding Explain syntax</h2>
          <p>
            Approximation - Does not consider triggers/proceedures etc.  Does not show opimizations.  Stats are estimates.  Query is actually run.  Filesort - ( in memory/ temp files) Temporary - (in memory/disk)
            Explain does execute sub queries since they must be executed first to
            optimize the outer loops appropriately
EXPLAIN EXTENDED with show warnings. -> Query the QEP has actually run.  May have modified original statement.
          </p>
        </section>

        <section>
          <h3>Types of query</h3>
          <table>
            <tr>
              <td>all</td>
              <td>full table scan</td>
            </tr>
            <tr>
              <td>index</td>
              <td>index scan</td>
            </tr>
            <tr>
              <td>range</td>
              <td>limited index scan</td>
            </tr>
            <tr>
              <td>ref</td>
              <td>one or more match based on index</td>
            </tr>
            <tr>
              <td>eq_ref</td>
              <td>single value match based on index</td>
            </tr>
            <tr>
              <td>const</td>
              <td></td>
            </tr>
            <tr>
              <td>NULL</td>
              <td>information from index.  No table access</td>
            </tr>
          </table>
        </section>

        <section>
          <h2>Basic index</h2>
	  <pre><code data-trim contenteditable>
ingram, presentation> EXPLAIN  SELECT COUNT(*) FROM fakenames_full WHERE dob = '1980-01-01 00:00:00';
+----+-------------+----------------+------+---------------+------+---------+------+--------+-------------+
| id | select_type | table          | type | possible_keys | key  | key_len | ref  | rows   | Extra       |
+----+-------------+----------------+------+---------------+------+---------+------+--------+-------------+
|  1 | SIMPLE      | fakenames_full | ALL  | NULL          | NULL | NULL    | NULL | 999757 | Using where |
+----+-------------+----------------+------+---------------+------+---------+------+--------+-------------+
1 row in set (0.01 sec)
          </code></pre>
	  <pre  class="fragment"><code data-trim contenteditable>
singram, presentation> ALTER TABLE fakenames_full ADD INDEX (dob);
Query OK, 0 rows affected (4.43 sec)
Records: 0  Duplicates: 0  Warnings: 0

singram, presentation> EXPLAIN SELECT COUNT(*) FROM fakenames_full WHERE dob = '1940-01-01 00:00:00';
+----+-------------+----------------+------+---------------+------+---------+-------+------+--------------------------+
| id | select_type | table          | type | possible_keys | key  | key_len | ref   | rows | Extra                    |
+----+-------------+----------------+------+---------------+------+---------+-------+------+--------------------------+
|  1 | SIMPLE      | fakenames_full | ref  | dob           | dob  | 9       | const |   43 | Using where; Using index |
+----+-------------+----------------+------+---------------+------+---------+-------+------+--------------------------+
1 row in set (0.00 sec)

           </code></pre>
        </section>

        <section>
          <h2>Functions and indexes</h2>
          <p>How does the index know the result of a function performed upon its values at query time?</p>
          <p class="fragment">It doesn't</p>
        </section>

        <section>
          <h3>Bad</h3>
	  <pre><code data-trim contenteditable>
SELECT COUNT(*) FROM fakenames_full WHERE YEAR(dob)='1980';
          </code></pre>
          <h3>Good</h3>
	  <pre><code data-trim contenteditable>
SELECT COUNT(*) FROM fakenames_full
WHERE dob BETWEEN '1980-01-01 00:00:00' AND '1980-12-31 23:59:59';
          </code></pre>
	  <pre><code data-trim contenteditable>
ALTER TABLE fakenames_full ADD dob_year SMALLINT AFTER dob;
UPDATE fakenames_full SET dob_year = YEAR(dob);
ALTER TABLE fakenames_full ADD INDEX (dob_year);
SELECT COUNT(*) FROM fakenames_full WHERE dob_year = 1980;
          </code></pre>
        </section>

        <section>
          <h2>Strings and indexes</h2>
          <h3>Bad</h3>
	  <pre><code data-trim contenteditable>
SELECT name FROM people WHERE name LIKE '%x%'
          </code></pre>
          <h3>Good</h3>
	  <pre><code data-trim contenteditable>
SELECT name FROM people WHERE name LIKE 'x%'
          </code></pre>
        </section>

        <section>
          <h2>Compound Index</h2>
          <ul>
            <li>Ordering is important</li>
            <li>Index merge (5.6)</li>
            <li>Redundancy</li>
          </ul>
        </section>
        <section>
          <h2>Covering Index</h2>
          <ul>
            <li>
              - Example
              - Benifits to secondary keys (No pk lookup)
            </li>
          </ul>
        </section>
        <section>
          <h2>Index selection</h2>
          <ul>
            <li>Don't mess with the optimizer</li>
            <li>It's *usually* right</li>
            <li>No index - Sometimes it's more trouble to access index than do
              full table scan</li>
          </ul>
        </section>
        <section>
          <h2>Left joins vs Inner join</h2>
        </section>
        <section>
          <h2>UNION trick</h2>
        </section>
        <section>
          <h2>Sort/Group By</h2>
        </section>

        <section>

          <h2>Aggregation tables.</h2>
          Large reports
          Avoid cache stampeed

        </section>
        <section>

          <h2>Andrie's rule</h2>
          <ul>
            <li>Remember the rules</li>
            <li>Understand the rules</li>
            <li>Break the rules when necessary</li>
            <li class="fragment">(Except Stuarts #1 and #2)</li>
          </ul>
        </section>


	<section>
	  <h1>THE END</h1>
	  <h3>BY Stuart Ingram</h3>
	</section>

      </div>

    </div>

    <script src="reveal/lib/js/head.min.js"></script>
    <script src="reveal/js/reveal.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
      controls: true,
      progress: true,
      history: true,
      center: true,

      theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
      transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

      // Optional libraries used to extend on reveal.js
      dependencies: [
      { src: 'reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },
      { src: 'reveal/plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'reveal/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
      { src: 'reveal/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
      { src: 'reveal/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
      // { src: 'reveal/plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
      // { src: 'reveal/plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
      ]
      });

    </script>

  </body>
</html>
